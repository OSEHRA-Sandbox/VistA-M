VPSRPC15  ;BPOIFO/KG - Patient Problems;07/31/14 13:07
 ;;1.0;VA POINT OF SERVICE (KIOSKS);**4**;Jul 31, 2014;Build 27
 ;;Per VHA Directive 2004-038, this routine should not be modified.
 ;
 ; External Reference DBIA#
 ; ------------------------
 ; #2741 - DETAIL^GMPLUTL2   (Controlled Sub)
 ; #2741 - LIST^GMPLUTL2     (Controlled Sub)
 ; #2977 - GETFLDS^GMPLEDT3  (Controlled Sub)
 QUIT
 ;
GETPRBLM(VPSARR,DFN) ;given DFN, returns the patient problems
 N ICDIEN,PRBIEN,PRBIENS,PRBINFO,GMPL
 ;
 ;--- Load a list of active problems
 N PLST D LIST^GMPLUTL2(.PLST,DFN,"A",0) ; Returns list of Prob for Pt.
 ;
 ;--- Browse through the problems
 N CNT S CNT=0
 N FILE S FILE=9000011
 N EXIST S EXIST=0
 ;
 F  S CNT=$O(PLST(CNT)) Q:CNT=""  D
 . S PRBIEN=$P(PLST(CNT),U)
 . Q:PRBIEN'>0
 . S EXIST=1
 . K GMPL D DETAIL^GMPLUTL2(PRBIEN,.GMPL)
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.01,$G(GMPL("DIAGNOSIS")),"DIAGNOSIS")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.03,$G(GMPL("MODIFIED")),"DATE LAST MODIFIED")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.05,$G(GMPL("NARRATIVE")),"PROVIDER NARRATIVE")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.06,$P($G(GMPL("FACILITY")),U,2),"FACILITY")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.08,$P($G(GMPL("ENTERED")),U),"DATE ENTERED")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,.12,$G(GMPL("STATUS")),"STATUS")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,1.02,$G(GMPL("CONDITION")),"CONDITION")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,1.03,$P($G(GMPL("ENTERED")),U,2),"ENTERED BY")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,1.04,$P($G(GMPL("RECORDED")),U,2),"RECORDING PROVIDER")
 . D SET(.VPSARR,FILE,DFN_";"_PRBIEN,1.05,$G(GMPL("PROVIDER")),"RESPONSIBLE PROVIDER")
 . D SETEXP(.VPSARR,FILE,DFN,PRBIEN) ;set expression
 ;
 I 'EXIST D SET(.VPSARR,"E",DFN,"","NO PROBLEM RECORDS FOUND FOR PATIENT","PROBLEM NOT FOUND")
 QUIT
 ;
SETEXP(VPSARR,FILE,DFN,PRBIEN) ;set expression
 N GMPVAMC S GMPVAMC=0
 N GMPPROV S GMPROV=0
 N GMPORIG,GMPFLD
 D GETFLDS^GMPLEDT3(PRBIEN)
 D SET(.VPSARR,FILE,DFN_";"_PRBIEN,1.01,$P($G(GMPFLD(1.01)),U,2),"EXPRESSIONS")
 QUIT
 ;
SET(VPSARR,VPSFL,VPSIEN,VPSFLD,VPSDA,VPSDS) ;Set line item to output array
 I VPSDA'="" D SET^VPSRPC1(.VPSARR,VPSFL,VPSIEN,VPSFLD,VPSDA,$G(VPSDS),5) ;Set line item to output array
 QUIT
